<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>BusDick</title>
</head>
<body>
<form id="busForm">
    <input id="date" type="date" name="date">
</form>
<table id="routes">
    <thead>
    <tr>
        <td>Id</td>
        <th>Дата</th>
        <th>Время</th>
        <th>Свободно мест</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<div id="listeners"></div>
<div id="log"></div>
<script>
    fetchRoutes(getDate(1)).then(renderRoutes);

    const $dateForm = document.querySelector("#busForm");
    const $date = document.querySelector("#date");
    const $log = document.querySelector("#log")

    $date.value = getDate(1);

    const $routes = document.querySelector("#routes");
    const $listeners = document.querySelector("#listeners");
    let listeners = [];

    renderListeners();
    setInterval(listen, 10_000)

    document.querySelector("#date").addEventListener("change", e => {
        e.preventDefault();
        const date = $date.value;
        fetchRoutes(date).then(renderRoutes);
    });

    function renderRoutes(routes) {
        const $thead = $routes.querySelector("thead");
        $thead.innerHTML = routes
            .map(route => `
<tr>
<td>${route.id}</td>
<td>${route.dateDeparture}</td>
<td>${route.timeDeparture}</td>
<td>${route.freePlaces}</td>
<td><button ${!!route.freePlaces ? "disabled" : ""} onCLick="addRouteListener(${route.id})">Слушать</button></td>
</tr>`)
            .join("");
    }

    async function fetchRoutes(date) {
        const url = new URL("https://buspro.by/api/trip?s%5Bcompany_id%5D=15&s%5Bcity_departure_id%5D=101&s%5Bcity_destination_id%5D=102&actual=1");
        url.searchParams.set("s[date_departure]", date)
        const response = await fetch(url.toString());
        const routes = Object.values(await response.json())
        return routes;
    }

    function getDate(value) {
        let date = new Date();
        date.setDate((date.getDate() + value));
        return date.toISOString().slice(0, 10);
    }

    function addRouteListener(id) {
        listeners.push({id})
        renderListeners();
    }

    function removeRouteListener(id) {
        listeners = listeners.filter(listener => listener.id !== id);
        renderListeners();
    }

    function renderListeners() {
        $listeners.innerHTML = listeners.map(listener => `
<div class="listener">
    <p>${listener.id}</p>
    <button onCLick="removeRouteListener(${listener.id})">Прекратить слушать</button>
</div>`).join("")
    }

    async function listen() {
        for(let listener of listeners) {
            const response = await fetch(`https://buspro.by/api/trip/${listener.id}`);
            const route = await response.json();
            if(route.freePlaces) notifyRouteFound(listener.id);
        }
    }

    function notifyRouteFound(id) {
        const audio = new Audio("beep.mp3");
        audio.play();
        const $logger = document.createElement("div");
        $logger.innerHTML = "Есть места на " + id;
        $log.append($logger);

        setTimeout(() => {
            $logger.remove();
        }, 10_000)
    }
</script>
</body>
</html>